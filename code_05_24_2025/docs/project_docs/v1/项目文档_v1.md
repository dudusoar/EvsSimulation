# 电车司机仿真系统项目文档

## 项目概述

基于现有代码重新设计的电车司机仿真系统，模拟电车在城市中接送顾客、完成订单并充电的行为。系统采用清晰的模块化架构，便于维护和扩展。

## 核心数据结构

### 1. 地图网络 (Graph)

```python
# 基于现有 OGraph 类简化
{
    'nodes': {node_id: {'x': float, 'y': float, 'type': str}},
    'edges': {(from_node, to_node): {'length': float, 'travel_time': float}},
    'charging_stations': [node_id1, node_id2, ...]  # 充电站节点列表
}
```

### 2. 车辆状态 (Vehicle)

```python
# 基于现有 Vehicle 类优化
{
    'vehicle_id': str,
    'position': {'x': float, 'y': float},
    'velocity': {'vx': float, 'vy': float},
    'status': str,  # 'idle', 'to_pickup', 'with_passenger', 'to_charging', 'charging'
    'battery': {
        'current_level': float,    # 当前电量 (%)
        'max_capacity': float,     # 最大电量 (%)
        'consumption_rate': float  # 耗电率 (%/km)
    },
    'current_task': {
        'type': str,      # 'order' 或 'charging'
        'target_node': int,
        'task_id': str
    },
    'path': {
        'route_nodes': [node_id1, node_id2, ...],  # 节点路径
        'path_points': [(x1,y1), (x2,y2), ...],   # 详细路径点
        'current_target': (x, y)                   # 当前目标点
    }
}
```

### 3. 订单数据 (Order)

```python
{
    'order_id': str,
    'pickup_location': {'node_id': int, 'x': float, 'y': float},
    'dropoff_location': {'node_id': int, 'x': float, 'y': float},
    'creation_time': float,
    'status': str,  # 'pending', 'assigned', 'picked_up', 'completed'
    'assigned_vehicle_id': str,
    'price': float,
    'estimated_distance': float
}
```

### 4. 充电站数据 (ChargingStation)

```python
{
    'station_id': str,
    'node_id': int,
    'position': {'x': float, 'y': float},
    'capacity': int,           # 总充电位
    'available_slots': int,    # 可用充电位
    'charging_power': float,   # 充电功率 (kW)
    'price_per_kwh': float,    # 电价
    'charging_vehicles': [vehicle_id1, vehicle_id2, ...]
}
```

## 模块架构

### 1. 地图模块 (MapManager)

**继承现有功能**: `osm_request.py` + `graph_search.py`

**核心功能**:

```python
class MapManager:
    def __init__(self, location_query: str)
    def get_shortest_path(self, from_node: int, to_node: int) -> list
    def get_node_position(self, node_id: int) -> tuple
    def get_random_nodes(self, n: int) -> list
    def get_travel_distance(self, from_node: int, to_node: int) -> float
    def find_nearest_charging_station(self, position: tuple) -> int
```

**输入**: 地理位置查询 **输出**: 路网数据、路径规划结果

### 2. 车辆管理模块 (VehicleManager)

**继承现有功能**: `vehicle.py` + `vehicle_management.py` + `vision.py`

**核心功能**:

```python
class VehicleManager:
    def __init__(self, vehicles: list, map_manager: MapManager)
    def update_all_vehicles(self, dt: float)
    def get_available_vehicles(self) -> list
    def get_vehicles_by_status(self, status: str) -> list
    def assign_task(self, vehicle_id: str, task: dict)
    def check_battery_levels(self, threshold: float = 20.0) -> list
    def get_fleet_statistics(self) -> dict
```

**主要改进**:

- 简化 `FrontView` 逻辑，直接集成到车辆更新中
- 统一车辆状态管理
- 优化路径跟踪算法

### 3. 订单系统 (OrderSystem)

**新增模块**，包含订单生成和分配

**核心功能**:

```python
class OrderSystem:
    def __init__(self, map_manager: MapManager)
    def generate_orders(self, current_time: float, demand_rate: float) -> list
    def assign_order(self, order: dict, available_vehicles: list) -> str
    def complete_order(self, order_id: str, completion_time: float)
    def get_pending_orders(self) -> list
    def calculate_order_price(self, pickup_node: int, dropoff_node: int) -> float
```

### 4. 充电管理模块 (ChargingManager)

**新增模块**

**核心功能**:

```python
class ChargingManager:
    def __init__(self, charging_stations: list)
    def request_charging(self, vehicle_id: str, station_id: str) -> bool
    def update_charging_progress(self, dt: float)
    def find_optimal_charging_station(self, vehicle_position: tuple) -> str
    def calculate_charging_cost(self, energy_amount: float, station_id: str) -> float
    def release_charging_slot(self, vehicle_id: str)
```

### 5. 仿真引擎 (SimulationEngine)

**继承现有功能**: `simulation.py` 核心逻辑

**核心功能**:

```python
class SimulationEngine:
    def __init__(self, config: dict)
    def initialize_simulation(self)
    def run_step(self, dt: float)
    def run_simulation(self, duration: float)
    def collect_metrics(self) -> dict
    def should_vehicle_charge(self, vehicle: dict) -> bool
```

**主要职责**:

- 协调所有模块
- 管理仿真时间循环
- 处理车辆充电决策
- 收集统计数据

### 6. 可视化模块 (Visualizer)

**继承现有功能**: `animate.py` + `artist.py`

**核心功能**:

```python
class Visualizer:
    def __init__(self, map_manager: MapManager, config: dict)
    def setup_animation(self, simulation_engine: SimulationEngine)
    def update_frame(self, frame_num: int)
    def draw_vehicles(self, vehicles: list)
    def draw_orders(self, orders: list)
    def draw_charging_stations(self, stations: list)
    def save_animation(self, filename: str, format: str = 'html')
```

### 7. 数据管理模块 (DataManager)

**新增模块**，处理数据持久化

**核心功能**:

```python
class DataManager:
    def __init__(self, output_dir: str = 'simulation_data')
    def save_simulation_state(self, state: dict, timestamp: float)
    def load_simulation_state(self, timestamp: float) -> dict
    def export_metrics(self, metrics: dict, format: str = 'csv')
    def generate_report(self, simulation_results: dict) -> str
```

## 模块间信息流动

```
仿真引擎 (SimulationEngine) - 中央协调器
    ├─ 地图模块 (MapManager) - 提供路径规划服务
    ├─ 车辆管理 (VehicleManager) - 管理车辆状态和移动
    ├─ 订单系统 (OrderSystem) - 生成和分配订单
    ├─ 充电管理 (ChargingManager) - 处理充电逻辑
    ├─ 可视化 (Visualizer) - 显示仿真过程
    └─ 数据管理 (DataManager) - 保存和导出数据
```

## 仿真流程优化

### 初始化阶段

1. 加载地图数据（复用 OSM 加载逻辑）
2. 创建充电站（在地图节点中随机选择）
3. 初始化车辆（复用随机位置生成）
4. 配置仿真参数

### 仿真循环 (每个时间步)

1. **订单管理**
    
    - 生成新订单（基于时间和需求模式）
    - 分配订单给空闲车辆
2. **车辆更新**
    
    - 更新所有车辆位置（复用现有移动逻辑）
    - 检查任务完成情况
    - 更新电池电量
3. **充电决策**
    
    - 检查低电量车辆
    - 安排充电任务
    - 更新充电进度
4. **数据收集**
    
    - 统计关键指标
    - 更新可视化
    - 保存状态（可选）

## 现有代码功能保留和改进

### 保留的核心功能

1. **OSM 地图加载** (`osm_request.py`)
    
    - 保留缓存机制
    - 保留图形投影功能
2. **路径规划** (`graph_search.py`)
    
    - 保留最短路径算法
    - 保留路径点生成逻辑
3. **车辆移动** (`vehicle.py` + `vision.py`)
    
    - 保留基础移动算法
    - 简化前视逻辑，直接集成到车辆更新中
4. **动画系统** (`animate.py`)
    
    - 保留实时可视化
    - 保留状态颜色编码

### 主要改进

1. **简化数据结构**: 减少不必要的嵌套和复杂性
2. **统一接口**: 所有模块提供清晰的输入输出接口
3. **移除冗余**: 删除 `FrontView` 的复杂逻辑，直接在车辆更新中处理
4. **增强功能**: 添加订单系统和充电管理

## 配置参数

```python
SIMULATION_CONFIG = {
    # 基础参数
    'location': "West Lafayette, IN",
    'simulation_duration': 3600,    # 秒
    'time_step': 0.1,              # 秒
    
    # 车辆参数
    'num_vehicles': 20,
    'vehicle_speed': 50,           # km/h
    'battery_capacity': 100,       # %
    'energy_consumption': 0.2,     # %/km
    'charging_threshold': 20,      # %
    
    # 订单参数
    'order_generation_rate': 5,    # 订单/小时
    'base_price_per_km': 2.0,     # 元/km
    
    # 充电参数
    'num_charging_stations': 5,
    'charging_power': 50,          # kW
    'electricity_price': 0.8,      # 元/kWh
    
    # 可视化参数
    'enable_animation': True,
    'animation_fps': 30,
    'save_data': False
}
```

## 输出结果

### 实时指标

- 车辆状态分布
- 订单完成情况
- 充电站使用率
- 平均等待时间

### 最终报告

- 总收益统计
- 车辆利用率
- 电量使用效率
- 充电成本分析

## 技术实现要点

1. **模块独立性**: 每个模块可以单独测试和维护
2. **数据一致性**: 统一的数据结构，避免转换开销
3. **性能优化**: 基于现有高效算法，避免重复计算
4. **扩展性**: 预留接口支持新功能添加
5. **简洁原则**: 去除不必要的复杂性，保持代码清晰

这个重构版本保留了现有代码的核心功能，同时大幅简化了架构，使其更易于理解和维护。主要改进包括统一的数据结构、清晰的模块职责划分，以及完整的订单和充电管理功能。